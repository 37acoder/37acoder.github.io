<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>老尹的一道Golang面试必杀题-并发加载 | Hero37&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/imgs/logo.png">
    <meta name="description" content="37A的个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.8d116657.css" as="style"><link rel="preload" href="/assets/js/app.8efeaaba.js" as="script"><link rel="preload" href="/assets/js/2.b7f7a349.js" as="script"><link rel="preload" href="/assets/js/21.65a4bdc9.js" as="script"><link rel="prefetch" href="/assets/js/10.b5581fb5.js"><link rel="prefetch" href="/assets/js/11.e2a65226.js"><link rel="prefetch" href="/assets/js/12.ddf1d4bf.js"><link rel="prefetch" href="/assets/js/13.8900cfc9.js"><link rel="prefetch" href="/assets/js/14.9d7a1e92.js"><link rel="prefetch" href="/assets/js/15.46b77f51.js"><link rel="prefetch" href="/assets/js/16.983cead3.js"><link rel="prefetch" href="/assets/js/17.75470d12.js"><link rel="prefetch" href="/assets/js/18.d45896cd.js"><link rel="prefetch" href="/assets/js/19.437aedc3.js"><link rel="prefetch" href="/assets/js/20.9ccbc123.js"><link rel="prefetch" href="/assets/js/22.25211b16.js"><link rel="prefetch" href="/assets/js/3.6cae0475.js"><link rel="prefetch" href="/assets/js/4.c610d016.js"><link rel="prefetch" href="/assets/js/5.216dfe20.js"><link rel="prefetch" href="/assets/js/6.73a8f323.js"><link rel="prefetch" href="/assets/js/7.1010668f.js"><link rel="prefetch" href="/assets/js/8.2d717214.js"><link rel="prefetch" href="/assets/js/9.62dfcaf8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8d116657.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/imgs/logo.webp" alt="Hero37's Blog" class="logo"> <span class="site-name can-hide">Hero37's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术文章" class="dropdown-title"><span class="title">技术文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术文章" class="mobile-dropdown-title"><span class="title">技术文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tech/language/" class="nav-link router-link-active">
  编程语言
</a></li><li class="dropdown-item"><!----> <a href="/tech/system/" class="nav-link">
  计算机系统
</a></li><li class="dropdown-item"><!----> <a href="/tech/hardware/" class="nav-link">
  嵌入式软件
</a></li><li class="dropdown-item"><!----> <a href="/tech/SE/" class="nav-link">
  软件工程
</a></li></ul></div></div><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="https://space.bilibili.com/2876324/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  B站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/37acoder/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="技术文章" class="dropdown-title"><span class="title">技术文章</span> <span class="arrow down"></span></button> <button type="button" aria-label="技术文章" class="mobile-dropdown-title"><span class="title">技术文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tech/language/" class="nav-link router-link-active">
  编程语言
</a></li><li class="dropdown-item"><!----> <a href="/tech/system/" class="nav-link">
  计算机系统
</a></li><li class="dropdown-item"><!----> <a href="/tech/hardware/" class="nav-link">
  嵌入式软件
</a></li><li class="dropdown-item"><!----> <a href="/tech/SE/" class="nav-link">
  软件工程
</a></li></ul></div></div><div class="nav-item"><a href="/life/" class="nav-link">
  生活
</a></div><div class="nav-item"><a href="https://space.bilibili.com/2876324/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  B站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/37acoder/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/tech/" class="sidebar-heading clickable router-link-active open"><span>技术</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/tech/language/" class="sidebar-heading clickable router-link-active open"><span>编程语言</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-2"><a href="/tech/language/golang/" class="sidebar-heading clickable router-link-active open"><span>Golang</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/tech/language/golang/InterfaceOfGolang.html" class="sidebar-link">语言-Golang Interface-解析Golang的接口</a></li><li><a href="/tech/language/golang/singleflight.html" class="sidebar-link">三方库-Singleflight-解决并发雪崩问题</a></li><li><a href="/tech/language/golang/yichyaquestion.html" aria-current="page" class="active sidebar-link">语言-golang经典面试题-并发加载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tech/language/golang/yichyaquestion.html#题干" class="sidebar-link">题干</a></li><li class="sidebar-sub-header"><a href="/tech/language/golang/yichyaquestion.html#无并发解法" class="sidebar-link">无并发解法</a></li><li class="sidebar-sub-header"><a href="/tech/language/golang/yichyaquestion.html#仅使用go关键字并发" class="sidebar-link">仅使用go关键字并发</a></li><li class="sidebar-sub-header"><a href="/tech/language/golang/yichyaquestion.html#使用互斥锁和waitgroup保证并发安全和同步的解法" class="sidebar-link">使用互斥锁和WaitGroup保证并发安全和同步的解法</a></li><li class="sidebar-sub-header"><a href="/tech/language/golang/yichyaquestion.html#使用context做超时控制的解法" class="sidebar-link">使用Context做超时控制的解法</a></li><li class="sidebar-sub-header"><a href="/tech/language/golang/yichyaquestion.html#使用channel做并发同步和超时控制的解法" class="sidebar-link">使用Channel做并发同步和超时控制的解法</a></li><li class="sidebar-sub-header"><a href="/tech/language/golang/yichyaquestion.html#使用生产者消费者模型控制并发数量的解法" class="sidebar-link">使用生产者消费者模型控制并发数量的解法</a></li><li class="sidebar-sub-header"><a href="/tech/language/golang/yichyaquestion.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></section></li></ul></section></li><li><a href="/tech/system/" class="sidebar-link">计算机系统</a></li><li><a href="/tech/hardware/" class="sidebar-link">嵌入式软件</a></li><li><a href="/tech/SE/" class="sidebar-link">软件工程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/life/" class="sidebar-heading clickable"><span>生活</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="老尹的一道golang面试必杀题-并发加载"><a href="#老尹的一道golang面试必杀题-并发加载" class="header-anchor">#</a> 老尹的一道Golang面试必杀题-并发加载</h1> <p>老尹是某公司的资深后台研发工程师，他有一道经典原创的Golang的面试题。这道题可谓是考查<strong>了Golang并发编程下的的大部分知识点，<strong>可谓是Golang并发写的不熟练的候选者的</strong>必杀题。</strong></p> <p>多次面试中老尹献出必杀技，候选人非死即残，Golang掌握程度立马显出原形。某位候选在面试到老板面时，因为老板想起来二面在老尹的这道面试题答的不好而惨遭挂掉。</p> <p>那么我们来一步一步了解这道面试题。</p> <h2 id="题干"><a href="#题干" class="header-anchor">#</a> 题干</h2> <p>给你一个<code>map[string]int64</code>， key是<code>UrlNum</code>个URL链接，在<code>MaxWaitTime</code>秒时间对URL的Get，并将响应状态保存在这个Map里，超过X秒未返回的结果丢弃。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;context&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	MaxWaitTime <span class="token operator">=</span> time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">1000</span>
	UrlNum      <span class="token operator">=</span> <span class="token number">200</span>
<span class="token punctuation">)</span>

<span class="token comment">//func MockHttpGet(url string) int64 {</span>
<span class="token comment">//	fmt.Println(&quot;start load url:&quot;, url)</span>
<span class="token comment">//	time.Sleep(time.Duration((rand.Float32()-0.5)*float32(200*time.Millisecond)) + MaxWaitTime)</span>
<span class="token comment">//	fmt.Println(&quot;loaded url:&quot;, url)</span>
<span class="token comment">//	return 200</span>
<span class="token comment">//}</span>

<span class="token keyword">func</span> <span class="token function">RealHttpGet</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;start load url:&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
	req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequestWithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;loaded url&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">||</span> resp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">int64</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Resolver <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Load</span><span class="token punctuation">(</span>urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	urls <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> UrlNum<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> UrlNum<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">//urls[i] = strconv.Itoa(i)</span>
		urls<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;https://baidu.com/?arg=&quot;</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//var resolver Resolver = NoConcurrentResolver{} // change it</span>
	<span class="token comment">//var resolver Resolver = JustUseGoKeyWord{} // change it</span>
	<span class="token comment">//var resolver Resolver = UseMutexButWrongWaitGroup{} // change it</span>
	<span class="token comment">//var resolver Resolver = UseMutexAndWaitGroup{} // change it</span>
	<span class="token comment">//var resolver Resolver = UseContext{} // change it</span>
	<span class="token comment">//var resolver Resolver = UseContextAndChannel{} // change it</span>
	<span class="token keyword">var</span> resolver Resolver <span class="token operator">=</span> ConcurrentLimit<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// change it</span>
	startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	r <span class="token operator">:=</span> resolver<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span>
	sucCount <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> r <span class="token punctuation">{</span>
		<span class="token comment">//fmt.Printf(&quot;Load url:%s\tstatus:%d\n&quot;, k, v)</span>
		<span class="token keyword">if</span> v <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			sucCount <span class="token operator">+=</span> <span class="token number">1</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;success num:&quot;</span><span class="token punctuation">,</span> sucCount<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;time consume:&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


</code></pre></div><h2 id="无并发解法"><a href="#无并发解法" class="header-anchor">#</a> 无并发解法</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> NoConcurrentResolver <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n NoConcurrentResolver<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		r<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">RealHttpGet</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> r
<span class="token punctuation">}</span>
</code></pre></div><p>不起<code>goroutine</code>直接同步get......这种写法可能要被老尹一顿赞赏，然后因过于优秀而被挂掉...即使是同步get，这个代码也有一些缺点。</p> <p>map的初始化已经得知key的数量时，未提前分配内存：示例直接使用<code>map[string]int64{}</code>创建了一个空的map，然后再挨个增加key。在key数量增长过程中，map会随着扩容，带来多次内存分配。应该改为<code>make(map[string]int64, len(urls))</code></p> <h2 id="仅使用go关键字并发"><a href="#仅使用go关键字并发" class="header-anchor">#</a> 仅使用go关键字并发</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">// JustUseGoKeyWord 仅使用go关键字并发</span>
<span class="token keyword">type</span> JustUseGoKeyWord <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j JustUseGoKeyWord<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">RealHttpGet</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> r
<span class="token punctuation">}</span>
</code></pre></div><p>大家都知道golang的最大的特点是go关键字，可以在任何地方随手起一个goroutine来帮助我们并发。goroutine很像其它语言里的线程的概念。如果要并发，那我每一个url起一个goroutine去获取就行了。</p> <p>上面的代码有以下几点问题</p> <ol><li><p>存在对map的并发写</p> <p>golang的map不是并发安全的，并且在并发读写、并发写的情况下会出现数据竞争，当这种情况出现时，go运行时将会抛出panic。</p> <p>详细见：</p></li> <li><p>goroutine的闭包将循环变量包着了</p> <p>正如下面IDE的提示，循环变量被闭包函数所使用。这里牵扯到两点问题</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gu9nza0d0vj60ll08smxt02.jpg" alt=""></p> <ol><li><p>闭包函数中对函数外的变量的是引用传递。golang的for range循环中，循环变量的地址不会变，只是在每次循环时对该地址进行赋值。所以即使循环变量变更了，闭包函数内对循环变量的取值操作都会取到相同的地址。对于循环内对循环变量取地址的场景，有时候会出现非预期的逻辑异常。但我们这个场景没什么问题。</p></li> <li><p>go关键字执行的函数的执行时机不确定，但一定在当前代码行或之后执行。这会导致当在第一个循环起的goroutine的函数闭包内，在执行时却获取到了第二个循环甚至更后循环的循环变量。如下图所示，所有的goroutine都获取到了最后一个循环的循环变量，那也就是说，起了100个goroutine都Get了同一个Url...</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gu9o7tj8bfj60c30bbzkq02.jpg" alt="image-20210909001035656"></p></li></ol></li> <li><p>缺乏goroutine之间的同步机制：Load函数不会等待所有goroutine执行完毕就已经了，导致main函数也直接退出了。相当于goroutine起了个寂寞...</p> <p>golang的父goroutine和子goroutine(姑且将起goroutine的goroutine称为父goroutine)如果没有同步机制，父goroutine不会等待子goroutine执行完毕。</p> <p>对于进程的主gouroutine(main函数)，同样也不会等待其他goroutine执行完毕才退出进程。其他的goroutine由于进程的退出而中断执行。</p></li></ol> <h2 id="使用互斥锁和waitgroup保证并发安全和同步的解法"><a href="#使用互斥锁和waitgroup保证并发安全和同步的解法" class="header-anchor">#</a> 使用互斥锁和WaitGroup保证并发安全和同步的解法</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//UseMutexButWrongWaitGroup 错误使用使用互斥锁和WaitGroup保证并发安全和同步</span>
<span class="token keyword">type</span> UseMutexButWrongWaitGroup <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j UseMutexButWrongWaitGroup<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	mu <span class="token operator">:=</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">{</span><span class="token punctuation">}</span>
	wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> wg sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			result <span class="token operator">:=</span> <span class="token function">RealHttpGet</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
			mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			r<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> result
			mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> wg<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> r
<span class="token punctuation">}</span>
</code></pre></div><p>上面引入了golang标准库<code>sync</code>中的两个非常重要的并发原语<code>mutex</code>和<code>waitgroup</code>，二者都是基于<code>sync</code>库中另一个并发原语<code>atomic</code>原子操作(硬件指令)实现的。</p> <h3 id="mutex"><a href="#mutex" class="header-anchor">#</a> Mutex</h3> <p><code>sync.Mutex</code>理解为互斥锁或排他锁，当一个goroutine持有锁时，其他goroutine在执行加锁操作时会被阻塞，直到它获取到锁。互斥锁在很多语言里都是非常常见的，主要用来保护临界区。临界区内，仅有至多一个gorountine会运行。</p> <p>上面的代码示例了互斥锁的正确使用方式，对Map的并发读写就是一个临界区，需要加锁保护避免并发读写。</p> <p>官方也提供了另一个的互斥锁，如读写锁。读写锁可以允许多个goroutine同时持有读锁、至多允许一个goroutine持有写锁、读锁和写锁不能同时存在。但对于当前场景，我们只有写操作所以用基本的互斥锁就可以。对于读多写少的场景，可以考虑使用读写锁来提高性能。</p> <h3 id="waitgroup"><a href="#waitgroup" class="header-anchor">#</a> WaitGroup</h3> <p><code>sync.WaitGroup</code>从字面意思上理解，就是一个等待组，它对外暴露了三个方法<code>Add(x)</code>, <code>Done()</code>,<code>Wait()</code>。底层实现基于原子操作，并用一个96位长度的内存存储了等待者和被等待者的计数器，同时还保证了在32位机和64位机的原子对齐。</p> <p><code>Add(x)</code>方法对等待组增加x个计数，<code>Done()</code>方法对等待组减少一个计数，<code>Wait()</code>方法的调用会阻塞到当前等待组的计数器归零。计数器为负会导致异常。</p> <p>上面的代码示例是一个错误的使用方式。主要问题有两点：</p> <ol><li><p>闭包函数内获取到waitgroup的值，而非地址</p> <p>waitgroup由于在多goroutine共享，必须保证多个goroutine修改的waitgroup是同一个。由于golang的函数参数是值传递，导致函数内收到的waitgroup其实是父goroutine的waitgroup的值拷贝。即使在函数内对该waitgroup的值拷贝做任何操作，比如计数减1，也不会导致父goroutine的waitgroup有任何变化。导致父goroutine计数器一直不变，导致进程死锁并引发fatal error。如下图</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gu9p2unqwej60vi09otad02.jpg" alt="image-20210909004025022"></p> <p>我们从waitgroup的实现可以看到，其中包括了一个nocopy字段(类型为一个空struct)。一个nocopy字段会提醒编辑器检查值拷贝情况。对于这种需要多个goroutine修改的类型，一定注意要传递指针而非值。同理，<code>mutex</code>也需要使用指针传递。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">type</span> WaitGroup <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	noCopy noCopy
	state1 <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>Waitgroup的Add操作被异步执行</p> <p>WaitGroup的<code>Add</code>操作被放倒了新的goroutine内部去执行，之前提到了，goroutine内函数的执行可能在任何时。无法保证Add操作一定会在Wait之前全部执行。对于这个场景来说，很有可能子goroutine内还没执行到Add时父goroutine已经执行到Wait了，此时计数器为0，程序不阻塞就直接返回了。</p></li></ol> <h3 id="下面给出修正这两个问题后的代码"><a href="#下面给出修正这两个问题后的代码" class="header-anchor">#</a> 下面给出修正这两个问题后的代码</h3> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//UseMutexAndWaitGroup 正确使用互斥锁和WaitGroup保证并发安全和同步</span>
<span class="token keyword">type</span> UseMutexAndWaitGroup <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j UseMutexAndWaitGroup<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span>
	mu <span class="token operator">:=</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">{</span><span class="token punctuation">}</span>
	wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			result <span class="token operator">:=</span> <span class="token function">RealHttpGet</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
			mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			r<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> result
			mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wg<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> r
<span class="token punctuation">}</span>
</code></pre></div><p><strong>修改之后，我们终于能在终端看到执行的结果了</strong>。到此，我们完成了对多个URL的并发加载，但是我们<strong>依然没有完成控制在<code>MaxWaitTime</code>内</strong>。如果有个URL的加载时间过长，甚至会导致这个函数整体的运行时间过长。在实际的业务场景中，我们无法相信任何网络情况，必须要设置超时时间。下面的示例里将不会演示错误的写法。</p> <p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gu9pgba8mcj60ip0cqmxz02.jpg" alt="image-20210909005321643"></p> <h2 id="使用context做超时控制的解法"><a href="#使用context做超时控制的解法" class="header-anchor">#</a> 使用Context做超时控制的解法</h2> <p>由于要使用Context，我们将HttpGet的实现由mock改为调用http库来进行。下面是使用<code>Context</code>做超时控制的代码。其实到Context这一步来说，代码已经基本达到了功能要求。这道题已经算通过了。</p> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//UseContext 使用Context做超时控制</span>
<span class="token keyword">type</span> UseContext <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j UseContext<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span>
	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> MaxWaitTime<span class="token punctuation">)</span>
	wg <span class="token operator">:=</span> sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">{</span><span class="token punctuation">}</span>
	mu <span class="token operator">:=</span> sync<span class="token punctuation">.</span>Mutex<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">,</span> wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			result <span class="token operator">:=</span> <span class="token function">RealHttpGet</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
			mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			r<span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> result
			mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wg<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> r

</code></pre></div><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gu9qgd7169j60g40eqgny02.jpg" alt="image-20210909012800102"></p> <p>相较于之前的代码，我们貌似只是初始化了一个context，然后调用了<code>context.WithTimeOut</code>并设定了一个超时时间，他为什么就能做到超时控制呢？这是什么魔法？</p> <h3 id="context-库"><a href="#context-库" class="header-anchor">#</a> Context 库</h3> <p>Context是golang官方标准库的内容，本文不再讲解，可以见我的另一篇博客非常细致的讲解了context库，<a href="/tech/language/golang/contextlib">见这篇</a></p> <p>这里使用了Context库的WithTimeOut方法，WithTimeOut方法会返回一个带超时控制的context，调用context.Done()方法会返回一个channel，当超时时该channel会被关闭，其他情况下都是阻塞状态。http.NewRequestWithContext方法内部实现了对该channel的监听，当超时时请求会立刻返回，以达到超时控制的目的。</p> <p>一般来说，当遇到阻塞操作时，如果操作允许传递context且对context的超时做了处理，我们就可以通过WithTimeOut来控制操作的超时。</p> <p><strong>但如果阻塞操作无法控制呢？我们不再把带超时控制的context传递给http get方法，模拟一个不受控的阻塞操作。</strong></p> <p><strong>下面的代码示例，同时也演示了WithTimeOut方法实现和大部分带超时功能的常见实现。</strong></p> <h2 id="使用channel做并发同步和超时控制的解法"><a href="#使用channel做并发同步和超时控制的解法" class="header-anchor">#</a> 使用Channel做并发同步和超时控制的解法</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token comment">//UseContextAndChannel 使用Channel做并发同步和超时控制</span>
<span class="token keyword">type</span> UseContextAndChannel <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Url    <span class="token builtin">string</span>
	Status <span class="token builtin">int64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j UseContextAndChannel<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span>
	resultReceiver <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> Result<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span>
	closeChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 超时时间到后，该goroutine会关闭closeChan</span>
		<span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>MaxWaitTime<span class="token punctuation">)</span>
		<span class="token function">close</span><span class="token punctuation">(</span>closeChan<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
		<span class="token comment">// 并发加载</span>
		<span class="token keyword">go</span> j<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>closeChan<span class="token punctuation">,</span> url<span class="token punctuation">,</span> resultReceiver<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token comment">// 收集响应</span>
		<span class="token keyword">case</span> rs <span class="token operator">:=</span> <span class="token operator">&lt;-</span>resultReceiver<span class="token punctuation">:</span>
			r<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>Url<span class="token punctuation">]</span> <span class="token operator">=</span> rs<span class="token punctuation">.</span>Status
			count <span class="token operator">+=</span> <span class="token number">1</span>
			<span class="token comment">// 全部加载完毕</span>
			<span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token comment">// 避免超时</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>closeChan<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j UseContextAndChannel<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span>closeChan <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> url <span class="token builtin">string</span><span class="token punctuation">,</span> resultReceiver <span class="token keyword">chan</span><span class="token operator">&lt;-</span> Result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 不受控制的阻塞操作</span>
	result <span class="token operator">:=</span> <span class="token function">RealHttpGet</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> resultReceiver <span class="token operator">&lt;-</span> Result<span class="token punctuation">{</span>Url<span class="token punctuation">:</span> url<span class="token punctuation">,</span> Status<span class="token punctuation">:</span> result<span class="token punctuation">}</span><span class="token punctuation">:</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>closeChan<span class="token punctuation">:</span> <span class="token comment">// 避免resultReceiver的接收者停止接收而一直阻塞</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;timeout url:&quot;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><ol><li>首先起了一个用来控制超时的goroutine和channel<code>closeChan</code>，当到达超时时间后，channel会被关闭</li> <li>对每一个url，起一个goroutine去Get
<ol><li>进行不受控制的阻塞操作</li> <li>当阻塞操作结束后
<ol><li>如果resultReciver这个channel还有接收者，则会发送结果，否则阻塞住。</li> <li>如果受到了closeChan的关闭信号，则会停止阻塞，并退出。</li></ol></li></ol></li> <li>消费resultReciver这个channel的result
<ol><li>如果能够收到result，则计数器+1。当计数器和任务数相当时，退出。</li> <li>如果收到了closeChan的关闭信号，则会停止消费，并退出。</li></ol></li></ol> <p>closeChan作为一个超时控制的channel，它被所有的goroutine共享并且监听，关闭信号发出时说明已经超时，所有goroutine都应该停下阻塞操作并退出。对于处于HttpGet这个阻塞操作中的goroutine无能为力，因为这个操作不受控制。</p> <p>resultReceiver用来收集所有gorountine的响应的结果，并在主goroutine中去消费并将结果写入r这个map。如果只有一个goroutine写r这个map，则无须对map进行加锁。</p> <p>与其他讲channel的文章不同，我这里没有对resultReceiver这个channel进行主动的关闭操作。这会导致goroutine泄漏吗？显然不会，在超时信号接收到之后，所有goroutine都会退出。同时没有goroutine持有这个channel时，该channel就会自动被运行时GC。所以无须主动关闭这个channel，避免徒增复杂度。</p> <p>并发下对map的加锁和对channel的关闭不是一定且必须的，避免让定式思维限制住你的编码。</p> <h2 id="使用生产者消费者模型控制并发数量的解法"><a href="#使用生产者消费者模型控制并发数量的解法" class="header-anchor">#</a> 使用生产者消费者模型控制并发数量的解法</h2> <div class="language-go extra-class"><pre class="language-go"><code><span class="token keyword">const</span> MaxGoroutineNum <span class="token operator">=</span> <span class="token number">100</span>

<span class="token comment">//ConcurrentLimit 使用生产者消费者模型控制并发数量</span>
<span class="token keyword">type</span> ConcurrentLimit <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token punctuation">(</span>j ConcurrentLimit<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>urls <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">)</span>
	closeChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 超时时间到后，该goroutine会关闭closeChan</span>
		<span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>MaxWaitTime<span class="token punctuation">)</span>
		<span class="token function">close</span><span class="token punctuation">(</span>closeChan<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	resultReceiver <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> Result<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token comment">//taskProducer := make(chan string, len(urls)) // 同步做</span>
	taskPublisher <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 异步做</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 也可以同步做，将channel的缓存设置为len(urls)即可</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> url <span class="token operator">:=</span> <span class="token keyword">range</span> urls <span class="token punctuation">{</span>
			taskPublisher <span class="token operator">&lt;-</span> url
		<span class="token punctuation">}</span>
		<span class="token function">close</span><span class="token punctuation">(</span>taskPublisher<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	goNum <span class="token operator">:=</span> MaxGoroutineNum
	<span class="token keyword">if</span> MaxGoroutineNum <span class="token operator">&gt;</span> <span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		goNum <span class="token operator">=</span> <span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> goNum<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token comment">// 起goroutine异步消费任务，产生result</span>
		<span class="token keyword">go</span> j<span class="token punctuation">.</span><span class="token function">taskExecutor</span><span class="token punctuation">(</span>closeChan<span class="token punctuation">,</span> taskPublisher<span class="token punctuation">,</span> resultReceiver<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 消费result</span>
	count <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> rs <span class="token operator">:=</span> <span class="token operator">&lt;-</span>resultReceiver<span class="token punctuation">:</span>
			r<span class="token punctuation">[</span>rs<span class="token punctuation">.</span>Url<span class="token punctuation">]</span> <span class="token operator">=</span> rs<span class="token punctuation">.</span>Status
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;received result: &quot;</span><span class="token punctuation">,</span> rs<span class="token punctuation">)</span>
			count <span class="token operator">+=</span> <span class="token number">1</span>
			<span class="token keyword">if</span> count <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> r
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>closeChan<span class="token punctuation">:</span>
			<span class="token keyword">return</span> r
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j ConcurrentLimit<span class="token punctuation">)</span> <span class="token function">taskExecutor</span><span class="token punctuation">(</span>closeChan <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> taskPublisher <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> resultReceiver <span class="token keyword">chan</span><span class="token operator">&lt;-</span> Result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> rs <span class="token builtin">int64</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token comment">// 避免任务还未执行时就已经超时了</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>closeChan<span class="token punctuation">:</span>
			<span class="token keyword">return</span>
		<span class="token comment">// 接收任务</span>
		<span class="token keyword">case</span> task<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>taskPublisher<span class="token punctuation">:</span>
			<span class="token comment">// 已无任务，通道已关闭</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
				<span class="token comment">//fmt.Println(&quot;no task, goroutine exit&quot;)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 执行任务</span>
			rs <span class="token operator">=</span> <span class="token function">RealHttpGet</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">)</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token comment">// 避免执行完毕后超时或者已无Result的接收者</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>closeChan<span class="token punctuation">:</span>
				<span class="token comment">//fmt.Println(&quot;timeout after task executed, url:&quot;, task)</span>
				<span class="token keyword">return</span>
			<span class="token comment">// 生产Result</span>
			<span class="token keyword">case</span> resultReceiver <span class="token operator">&lt;-</span> Result<span class="token punctuation">{</span>Url<span class="token punctuation">:</span> task<span class="token punctuation">,</span> Status<span class="token punctuation">:</span> rs<span class="token punctuation">}</span><span class="token punctuation">:</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><ol><li>跟之前一样，首先起了一个用来控制超时的goroutine和channel，当到达超时时间后，channel会被关闭。</li> <li>创建一个任务生产者goroutine，生产任务到taskPublisher里。
<ol><li>这一步也可以同步做，我们可以创建一个带缓存队列的channel，同步把所有任务放进去之后再开始消费。</li> <li>当任务生产完毕后，关闭这个channel。告知所有消费者没有任务需要做了，请退出吧。</li></ol></li> <li>创建不大于最大并发数量的goroutine，当任务数少于最大并发数量时，显然只需要起任务数个goroutine。注意，这个goroutine即是任务的消费者，也是结果的生产者。开始进行巨大的事件循环
<ol><li>先监听closeChan有没有被关闭，关闭说明超时了，则需要退出。</li> <li>如果没有关闭，那我们就阻塞监听taskPublisher，直到有任务被消费到。
<ol><li>判断当前的消费结果是否是因为taskPublisher被关闭导致的，如果是，则任务是无效的。且taskPublisher没有任务需要消费了，则需要退出。</li> <li>进行HttpGet操作。</li> <li>获取到结果后，再次同时监听closeChan，判断有没有超时。</li> <li>如果同时没有超时，则阻塞发送结果到resultReceiver里，进行下一个事件循环。</li></ol></li></ol></li> <li>主goroutine里消费resultReceiver的同时监听closeChan。将结果写到r这个map里。</li></ol> <p>实际的生产环境中，或者实际业务场景下，我们不可能有完全相信输入，当输出的任务量很大时，我们如果对每个任务起一个goroutine去完成，很有可能导致goroutine数量徒增，进而导致goroutine调度开销变大，然后导致任务整体完成时间变长，甚至导致程序OOM退出等问题。</p> <p>所以，带并发数量控制、带超时控制、保证并发安全和同步的并发加载器才是生产环境上堪用的。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>这道面试题考查了下面几个知识点</p> <ol><li>map的初始化、使用和并发场景下需要注意的问题</li> <li>golang闭包和循环的坑</li> <li>sync.Mutex, sync.Waitgroup的使用</li> <li>context库的使用</li> <li>channel的使用</li> <li>goroutine间通信、同步手段</li> <li>goroutine数量控制</li></ol> <p>通过这道面试题，我们已经基本掌握了写好golang并发代码的能力，接下来我们可以这样几件事情，这几件事情都会成为单独的一篇博客讲解。</p> <ol><li>实现一个带超时、带并发控制的通用并发加载器框架</li> <li>实现一个基于内存的异步非阻塞的消息队列</li> <li>实现一个池化goroutine</li></ol> <p><a href="https://github.com/37acoder/mygopro/tree/main/concurrentload/yichyaquestion" target="_blank" rel="noopener noreferrer">本文的代码地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tech/language/golang/singleflight.html" class="prev">
        三方库-Singleflight-解决并发雪崩问题
      </a></span> <span class="next"><a href="/tech/system/">
        计算机系统
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8efeaaba.js" defer></script><script src="/assets/js/2.b7f7a349.js" defer></script><script src="/assets/js/21.65a4bdc9.js" defer></script>
  </body>
</html>
